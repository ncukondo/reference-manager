# Task: URL Command

## Purpose

Add `ref url` command for resolving and displaying reference URLs, and optionally
opening them in a browser. Researchers frequently need to access paper websites
(DOI pages, PubMed, etc.) from their reference library.

## References

- Spec: `spec/architecture/cli.md`
- Spec: `spec/features/interactive-id-selection.md`
- Data model: `spec/core/data-model.md` (DOI, URL, PMID, PMCID, additional_urls)
- Opener utility: `src/utils/opener.ts` (`openWithSystemApp`)
- Fulltext open (similar pattern): `src/cli/commands/fulltext.ts` (`executeFulltextOpen`)
- CSL types: `src/core/csl-json/types.ts`

## Design Decisions

### CLI Interface

```bash
ref url <id>...              # All URLs, no label (1 per line)
ref url <id> --default       # Best URL by priority (1 line)
ref url <id> --doi           # DOI URL only
ref url <id> --pubmed        # PubMed URL only
ref url <id> --pmcid         # PMC URL only
ref url <id> --open          # Open best URL in browser (implicit --default)
ref url <id> --open --pubmed # Open PubMed page
ref url <id> --uuid          # Interpret ID as UUID
ref url                      # Interactive ID selection (TTY fallback)
```

### URL Resolution Priority (for --default)

```
DOI > URL > PMID > PMCID > custom.additional_urls[0]
```

### URL Construction

| Source | URL Template |
|--------|-------------|
| `DOI` | `https://doi.org/{DOI}` |
| `URL` | as-is |
| `PMID` | `https://pubmed.ncbi.nlm.nih.gov/{PMID}/` |
| `PMCID` | `https://www.ncbi.nlm.nih.gov/pmc/articles/{PMCID}/` |
| `custom.additional_urls` | as-is |

### Output Format

**Single ID — URLs only (no label):**
```
https://doi.org/10.1000/example
https://journal.com/article/123
https://pubmed.ncbi.nlm.nih.gov/12345678/
```

**Multiple IDs — TSV (ID + URL):**
```
smith2023	https://doi.org/10.1000/example
smith2023	https://journal.com/article/123
jones2024	https://doi.org/10.2000/other
```

**With type filter (--default, --doi, etc.) — plain URL regardless of ID count:**
```
https://doi.org/10.1000/example
https://doi.org/10.2000/other
```

### Additional URLs

`custom.additional_urls` are included in default (no filter) output, after standard URLs.

### Interactive ID Selection

When invoked without ID in TTY environment, falls back to interactive search
(single-select mode). Follows `spec/features/interactive-id-selection.md` pattern.

### Error Handling

| Condition | Behavior |
|-----------|----------|
| No URLs available | Error message to stderr, exit code 1 |
| Filtered URL not available | Error: "No DOI URL for smith2023", exit code 1 |
| Non-TTY without ID | Error: "Identifier is required", exit code 1 |
| Reference not found | Error: "Reference not found: xxx", exit code 1 |
| `--open` fails | Error message to stderr, exit code 1 |

## TDD Workflow

For each step, follow the Red-Green-Refactor cycle (see `spec/guidelines/testing.md`).

## Steps

### Step 1: URL Resolution Module

Core logic for resolving URLs from a CslItem.

**Changes:**
- Create URL resolution functions:
  - `resolveAllUrls(item: CslItem): string[]` — all URLs in priority order
  - `resolveDefaultUrl(item: CslItem): string | null` — best URL by priority
  - `resolveUrlByType(item: CslItem, type: UrlType): string | null` — specific type
  - `buildUrl(item: CslItem, field: string): string` — construct URL from field value
- Define `UrlType = "doi" | "url" | "pubmed" | "pmcid"`

**Files:**
- `src/features/operations/url.ts` (new)

**Tests:**
- [ ] Write test: `src/features/operations/url.test.ts`
  - `resolveAllUrls` returns all URLs in priority order
  - `resolveAllUrls` includes additional_urls
  - `resolveDefaultUrl` returns DOI URL when available
  - `resolveDefaultUrl` falls back through priority chain
  - `resolveDefaultUrl` returns null when no URLs
  - `resolveUrlByType` returns correct URL for each type
  - `resolveUrlByType` returns null when type not available
- [ ] Create stub
- [ ] Verify Red
- [ ] Implement
- [ ] Verify Green
- [ ] Lint/Type check

### Step 2: URL Command Execution

Command logic for formatting output and handling --open.

**Changes:**
- `executeUrlCommand(options, context)` — resolve URLs, format output
- Output formatting:
  - Single ID, no filter: URLs only, 1 per line
  - Multiple IDs, no filter: TSV (id\turl)
  - With filter: plain URLs, 1 per line
- `--open` support: call `openWithSystemApp` with resolved URL

**Files:**
- `src/cli/commands/url.ts` (new)

**Tests:**
- [ ] Write test: `src/cli/commands/url.test.ts`
  - Single ID output format (URLs only)
  - Multiple ID output format (TSV)
  - `--default` returns single best URL
  - `--doi` / `--pubmed` / `--pmcid` filter correctly
  - Error when no URLs available
  - Error when filtered type not available
  - `--open` calls openWithSystemApp
- [ ] Create stub
- [ ] Verify Red
- [ ] Implement
- [ ] Verify Green
- [ ] Lint/Type check

### Step 3: Register CLI Command

Wire up Commander command and options.

**Changes:**
- Register `ref url [identifiers...]` command with options:
  `--default`, `--doi`, `--pubmed`, `--pmcid`, `--open`, `--uuid`
- Handle action: resolve context, call executeUrlCommand

**Files:**
- `src/cli/index.ts`
- `src/cli/commands/url.ts`

**Tests:**
- [ ] Write test: command registration and option parsing
- [ ] Implement
- [ ] Verify Green
- [ ] Lint/Type check

### Step 4: Interactive ID Selection Fallback

Support `ref url` without ID in TTY environment.

**Changes:**
- When no identifiers provided and TTY detected, launch interactive reference select
- Single-select mode (consistent with `fulltext open` pattern)
- After selection, proceed with URL resolution

**Files:**
- `src/cli/commands/url.ts`

**Tests:**
- [ ] Write test: fallback to interactive selection when no ID and TTY
- [ ] Write test: error when no ID and non-TTY
- [ ] Implement
- [ ] Verify Green
- [ ] Lint/Type check

## Manual Verification

**Script**: `test-fixtures/test-url-command.sh`

Non-TTY tests (automated):
- [ ] `ref url <id-with-doi>` outputs DOI URL
- [ ] `ref url <id1> <id2>` outputs TSV format
- [ ] `ref url <id> --default` outputs single URL
- [ ] `ref url <id> --doi` outputs DOI URL only
- [ ] `ref url <id> --pubmed` outputs PubMed URL only
- [ ] `ref url <nonexistent>` exits with error

TTY-required tests (run manually):
- [ ] `ref url` opens interactive selection
- [ ] `ref url <id> --open` opens browser

## Completion Checklist

- [ ] All tests pass (`npm run test`)
- [ ] Lint passes (`npm run lint`)
- [ ] Type check passes (`npm run typecheck`)
- [ ] Build succeeds (`npm run build`)
- [ ] Spec created: `spec/features/url.md`
- [ ] Spec updated: `spec/architecture/cli.md`
- [ ] Spec updated: `spec/features/interactive-id-selection.md` (add url to supported commands)
- [ ] CHANGELOG.md updated
- [ ] Move this file to `spec/tasks/completed/`
